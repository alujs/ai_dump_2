#!/usr/bin/env bash
set -euo pipefail

node -e "const requests=[{jsonrpc:'2.0',id:1,method:'initialize',params:{protocolVersion:'2024-11-05',clientInfo:{name:'stdio-smoke',version:'1.0.0'},capabilities:{tools:{}}}},{jsonrpc:'2.0',id:2,method:'tools/list',params:{}},{jsonrpc:'2.0',id:3,method:'tools/call',params:{name:'controller.turn',arguments:{runSessionId:'run_stdio_smoke',workId:'work_stdio_smoke',agentId:'agent_stdio_smoke',originalPrompt:'stdio smoke list',verb:'list',args:{anchors:{entrypoint:'src/index.ts',definition:'main'},lexemes:['ag-grid'],activePolicies:['policy:core:no_adp'],policyVersionSet:{core:'1'}}}}}]; for (const req of requests){const p=JSON.stringify(req); process.stdout.write('Content-Length: '+Buffer.byteLength(p)+'\r\n\r\n'+p);} " \
  | MCP_ENABLE_DASHBOARD=false node --import tsx src/mcp/stdioServer.ts \
  | node -e "let raw=''; process.stdin.on('data',d=>raw+=d.toString('utf8')); process.stdin.on('end',()=>{const responses=[]; while(true){const headerEnd=raw.indexOf('\r\n\r\n'); if(headerEnd===-1){break;} const header=raw.slice(0,headerEnd); const m=header.match(/Content-Length:\s*(\d+)/i); if(!m){throw new Error('Missing content length in response stream');} const len=Number(m[1]); const start=headerEnd+4; const end=start+len; const payload=raw.slice(start,end); responses.push(JSON.parse(payload)); raw=raw.slice(end);} const r1=responses.find(r=>r.id===1); const r2=responses.find(r=>r.id===2); const r3=responses.find(r=>r.id===3); if(!r1||!r2||!r3){throw new Error('Missing expected response ids');} if(r1.result?.protocolVersion!=='2024-11-05'){throw new Error('Unexpected initialize protocolVersion');} if(!Array.isArray(r2.result?.tools) || !r2.result.tools.some(t=>t.name==='controller.turn')){throw new Error('tools/list missing controller.turn');} const state=r3.result?.structuredContent?.state; if(state!=='PLAN_REQUIRED'){throw new Error('Unexpected tools/call state='+String(state));} console.log('MCP stdio transport smoke passed. responses='+responses.length); });"
